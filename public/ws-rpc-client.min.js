(function(){function b(){for(var a="",b=0,c=Math.floor,d=Math.random;s=String.fromCharCode,b<8;b++)a+=s(c(d()*26)+(c(d()*2)?97:65));return a}window.WebSocketRPC=WebSocketRPC=function(b,d,e,f){this.url=b,this.protocols=d,this.connTimeout=e||4e3,this.listeners={},this.reconnDelay=f||1e3,this.on("message",function(b){try{try{var c=JSON.parse(b.data)}catch(b){throw new Error("invalid data received")}if(c.r){var d=(this.__c||{})[c.r];if(!d)throw new Error("missing callback[4]:"+c.r);delete this.__c[c.r],d.apply(null,c.a);return}if(c.c){var e=this;c.a.push(function(){var d={r:c.c,a:Array.prototype.slice.call(arguments)};if(d.a.length&&(b=a=d.a[0])instanceof Error){d.a[0]={message:b.message,stack:b.stack};for(var f in b)a[f]=b[f]}e.socket.send(JSON.stringify(d))})}this.emit.apply(this,c.a)}catch(b){this.emit("error",b)}}),this.on("open",function(){this.__clearConnectTimeout()}),this.on("close",function(){if(this.socket){for(var a=0;a<c.length;a++)this.socket["on"+c[a]]=null;this.socket=null}this.__clearConnectTimeout();if(this.connTimeout!==-1){var b=this;setTimeout(function(){this.connTimeout!==-1&&b.connect()},b.reconnDelay)}}),this.connect()},WebSocketRPC.prototype.connect=function(){var a=this;if(this.socket){if(this.connTimeout!==-1)return this.disconnect();this.disconnect()}this.connTimeout!==-1&&(this.connTimer=setTimeout(function(){a.socket.readyState!==WebSocket.OPEN&&(a.__clearConnectTimeout(),a.disconnect())},this.connTimeout)),this.socket=new WebSocket(this.url,this.protocols);for(var b=0;b<c.length;b++)this.socket["on"+c[b]]=function(b){return function(){a.__dispatch(b,arguments)}}(c[b])},WebSocketRPC.prototype.disconnect=function(a){if(!this.socket)return;a&&(this.connTimeout=-1);try{this.socket.close()}catch(b){this.emit("error",b)}},WebSocketRPC.prototype.message=function(){var a=arguments.length-1,c={};if(typeof arguments[a]=="function"){this.__c||(this.__c={});do c.c=b();while(this.__c[c.c]);this.__c[c.c]=arguments[a--]}c.a=Array.prototype.slice.call(arguments,0,a+1),this.socket.send(JSON.stringify(c))},WebSocketRPC.prototype.on=function(a,b){this.listeners[a]=this.listeners[a]||[],this.listeners[a].push(b)},WebSocketRPC.prototype.removeListener=function(a,b){if(a in this.listeners==0)return;this.listeners[a].splice(this.listeners[a].indexOf(fct),1)},WebSocketRPC.prototype.emit=function(a){if(a in this.listeners==0)return;for(var b=0,c=this.listeners[a],d=c.length;b<d;b++)c[b].apply(this,Array.prototype.slice.call(arguments,1))},WebSocketRPC.prototype.__clearConnectTimeout=function(){this.connTimer&&(clearTimeout(this.connTimer),delete this.connTimer)},WebSocketRPC.prototype.__dispatch=function(a,b){var c=Array.prototype.slice.call(b);c.unshift(a),this.emit.apply(this,c)};var c=["open","error","close","message"]})();